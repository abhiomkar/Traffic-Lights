{% extends 'base.html' %}

<!-- the id on the containing div determines the page width. -->
<!-- #doc = 750px; #doc2 = 950px; #doc3 = 100%; #doc4 = 974px -->
{% block content %}
<div id="doc3" class="homepage container"> 
    <header id="header" class="container"> 
    <h1><a href="/" class="title logo">Traffic Lights</a></h1> 
    <a href="/checkins" class="check_roads floatright">Check Roads</a>
    <div class="clearboth"></div>
    </header> 
    <div id="map_canvas" style="width:96%; height:200px"></div>

    <div class="checkin_buttons">
        <strong>Loading Current Location...</strong>
        <input type="button" name="3" class="red_checkin_btn redbtn" value="RED" style="display: none" />
        <input type="button" name="2" class="orange_checkin_btn orangebtn" value="ORANGE" style="display: none" />
        <input type="button" name="1" class="green_checkin_btn greenbtn" value="GREEN" style="display: none" />
    </div>
    <div class="street_address">
    </div>
    <div class="notification">
    </div>
    <!--<form name="" class="" method="POST" action="/"> {% csrf_token %}-->
        <!--<input type="submit" class="" value="" />-->
    <!--</form> -->

</div>

<script type="text/javascript">

var watchProcess = null,
en_buttons = false,
cur_latitude = 0,
cur_longitude = 0,
cur_str_addr = 'here',
tr_dense_lvl = 0,
cur_latlng= '0,0',
latlng;


    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
  function setMap(lot, lng) {
	var lot = typeof(lot) != 'undefined' ? lot : -34.397,
    lng = typeof(lng) != 'undefined' ? lng : 150.644,     
	latlng = new google.maps.LatLng(lot, lng),	
	myOptions = {
	    zoom: 14,
	    center: latlng,
	    mapTypeId: google.maps.MapTypeId.ROADMAP }, 
	map = new google.maps.Map(document.getElementById("map_canvas"), myOptions),
    marker = new google.maps.Marker({
          position: latlng,
          title:"My Current Location!"
      });

    marker.setMap(map);
  }

  function initiate_watchlocation() {
      if (watchProcess == null) {
          watchProcess = navigator.geolocation.watchPosition(setPosition, function(err){ }, {maximumAge: 8000});
      }
  }

  function getAddress(cur_latitude, cur_longitude) {
	var latlng = new google.maps.LatLng(cur_latitude, cur_longitude);
	geocoder.geocode({'latLng': latlng}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          if (results[0]) {  
            cur_str_addr = results[0].formatted_address;
          }
        } else {
          alert("Geocoder failed due to: " + status);
        }});	
  }

  function setPosition(pos) {
      if(en_buttons == false) {
          en_buttons = true;
          $(".checkin_buttons strong").hide();
          $(".checkin_buttons input").show();
      }
      cur_latitude = pos.coords.latitude;
      cur_longitude = pos.coords.longitude;
      cur_latlng = cur_latitude + ',' + cur_longitude;
	  
	  // async'ly get the current address
	  setTimeout('getAddress(cur_latitude, cur_longitude)', 10);
      console.log('lat: ' + pos.coords.latitude);
      console.log('lng: ' + pos.coords.longitude);
      setMap(pos.coords.latitude, pos.coords.longitude);
  }


$(document).ready(function() {
	geocoder = new google.maps.Geocoder();
    // navigator.geolocation.getCurrentPosition(setPosition);

    function stopWatch() {
        navigator.geolocation.clearWatch(watchProcess);
    }

	initiate_watchlocation();

    // Set Map to Current Location
    // setMap();
    // Keep Watching the User's Current Location
    // setInterval("window.initiate_watchlocation()", 1000)

    // EVENTS
    $(".checkin_buttons input").click(function() {
        var self = this,
        postCheckin = function() {
         $.ajax({
                url: '/-post/',
                type: 'POST',
                success: function(response) {
                            // DEBUG
                            console.log('got response');
                            $(self).attr('value', 'Updated.');
                            var $alertdiv = $('<div id="notification"/>');
                            $alertdiv.text(response);
                            $alertdiv.bind('click', function() {
                                $(this).slideUp(200);
                            });
                            $(document.body).append($alertdiv);
                            $("#notification").slideDown("slow"); 
                            setTimeout(function() { $alertdiv.slideUp(200) }, 8000);
                         },
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                crossDomain: false,
                data: { "latitude": cur_latitude, 
                        "longitude": cur_longitude,
                        "street_address": cur_str_addr,
                        "traffic_dense_level": tr_dense_lvl,
                        "latlng": cur_latlng
                      }
            }); // end of ajax()
            return false;
          }

        $(".checkin_buttons input").not(this).hide('fast');
        $(this).animate({ width: '100%' }, 'fast');
        $(this).attr('value', 'Updating...');

        tr_dense_lvl = parseInt($(this).attr("name"));
		
		postCheckin();
		$(this).attr('disabled', true)

        // DEBUG
        console.log("latitude: "+ cur_latitude +"\n longitude: "+ cur_longitude + "\n street_address: "+ cur_str_addr + "\n traffic_dense_level: " + tr_dense_lvl);

        }); // end of click()
    }); // end of ready()
</script>
{% endblock %}
